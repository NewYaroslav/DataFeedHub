# Доменные типы тиков (`DataFeedHub::data::ticks`)

Этот домен описывает низкоуровневые структуры данных, которые используются для хранения, кодирования и передачи тиковых котировок, а также метаданные и конфигурации кодеков.

## Ключевые структуры

- **ValueTick** — одно скалярное значение + `time_ms`. Подходит для индикаторов или курсов без бид/аск.
- **QuoteTick** — `bid`, `ask`, `time_ms`.
- **QuoteTickVol** — `bid`, `ask`, единичный `volume` (метрика зависит от поставщика) и `time_ms`.
- **QuoteTickL1** — `bid`, `ask` + отдельные `bid_volume` и `ask_volume` для стакана уровня L1.
- **MarketTick** — «толстый» тик (last, volume, best bid/ask, флаги обновлений, статусы).
- **TradeTick** — сделка (`price`, `volume`, `time_ms`) с уплотнённым `id_and_side`, где 61 бит занимает `trade_id`, а верхние 3 бита — `TradeSide`.
- **SingleTick<T>** — обёртка над одним тиком с дополнительными метаданными (флаги обновлений, идентификаторы поставщика/инструмента и точность цен/объёмов).
- **TickSequence<T>** — последовательность тиков одного типа с теми же метаданными, что и у `SingleTick`. Используется при пакетной записи и сжатии.
- **TickSpan<T>** и алиасы **ValueTickSpan**, **QuoteTickSpan**, **QuoteTickVolSpan**, **QuoteTickL1Span**, **MarketTickSpan**, **TradeTickSpan** — лёгкое представление неизменяемого диапазона тиков (не владеет памятью).
- **TickMetadata** — описание временного диапазона, типа рынка, количества тиков и настроек хранения.
- **TickCodecConfig** — параметры кодека/компрессора, определяющие формат хранения и дополнительные признаки (например, необходимость сохранять флаги или объём).
- **BidAskRestoreConfig** — настройки восстановления бид/аск котировок из последней сделки.

## Флаги и перечисления

- `TickUpdateFlags`, `TickStatusFlags`, `TickStorageFlags` описывают состояние тика, обновлённые поля и параметры хранения. Для них реализованы constexpr-побитовые операции.
- `BidAskModel` определяет стратегию восстановления бид/аск.
- `TradeSide` хранит направление сделки (`Unknown`, `Buy`, `Sell`) и помещается в 3 бита. Значения вне диапазона 0..7 урезаются маской при упаковке в `TradeTick::id_and_side`.

## Типичный сценарий использования

1. Источник данных наполняет `MarketTick` или другой специализированный тип и выставляет соответствующие `TickUpdateFlags` через методы `set_flag`/`has_flag`.
2. Для отправки данных наружу выбирается `SingleTick` или `TickSequence` и в них записываются значения точности (`price_digits`/`volume_digits`) и идентификаторы провайдера.
3. При записи в хранилище формируется `TickMetadata` и `TickCodecConfig`. Эти структуры передаются в кодек компрессии тиков, который ориентируется на значения `TickStorageFlags`.
4. Для быстрых операций без копий (например, адаптация сетевых буферов) используется `TickSpan`, который лишь указывает на внешнюю память.

Каждая структура выровнена по 8 байтам и проверяется через `static_assert`, что гарантирует стабильный бинарный формат и высокую скорость обработки.

## JSON-сериализация

- Поддержка JSON отключена по умолчанию. Определите `DFH_USE_JSON` вместе с конкретным бэкендом (`DFH_USE_NLOHMANN_JSON`, `DFH_USE_SIMDJSON`), чтобы скомпилировать `to_json`/`from_json` и связанные хелперы.
- Все DTO, метаданные и конфигурации домена тиков оборачивают JSON-хелперы в эти макросы, чтобы зависимости не тянулись без необходимости.
- Контейнеры (`SingleTick`, `TickSequence`, `TickSpan`) сериализуются как полезная нагрузка тиков + метаданные (точность, идентификаторы, флаги).

## Именование типов тиков

1. **DTO-типы тиков** — форма `<Base><Suffix>Tick`, где `Base` задаёт доменную сущность (`Quote`, `Market`, `Value` и т.п.), а `Suffix` — опциональный модификатор (`Vol`, `L1`, `L2`, `Agg`). Примеры: `ValueTick`, `QuoteTick`, `QuoteTickVol`, `QuoteTickL1`, `MarketTick`.
2. **Контейнеры и алгоритмы для тиков** — форма `Tick<Something>`, например `TickSpan`, `TickSequence`, `TickSerializer`, `TickCompressorV1`.
3. **Span-алиасы** — форма `<TypeName>Span` для конкретного типа тика: `ValueTickSpan`, `QuoteTickSpan`, `QuoteTickVolSpan`, `QuoteTickL1Span`, `MarketTickSpan`, `TradeTickSpan`.
